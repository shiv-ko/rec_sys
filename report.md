# MovieLens 100K による協調フィルタリング実験レポート

## 1. 研究目的と概要
- 授業課題として MovieLens 100K (943 users / 1,682 items / 100,000 ratings) を用い、同一データ・同一評価指標上で Baseline（アイテム平均）、User-based CF、Item-based CF を比較した。
- 推薦らしさを担保するため各ユーザの最新 1 件をテストとする leave-one-out を採用し、「未来の 1 本を予測する」構成に揃えた。
- 評価はレーティング予測（RMSE / MAE）を主とし、Top-K 推薦の指標として任意で HitRate@10 を算出した。

## 2. データ前処理
- `u.data` を読み込み、`user_id`/`item_id` を `pd.factorize` で 0 始まりの `user_idx`/`item_idx` に変換し、配列インデックスとして扱いやすくした。
- 各ユーザ内で `timestamp` ソート後、末尾のみテストに送り残りを学習用にした (train: 99,057 / test: 943)。
- 学習データから `num_users × num_items` の行列 `R_train` を構築し、未観測セルには 0 を設定（実際の 0 評価ではないことをコメントで明示）。

## 3. 実装した手法
### 3.1 ItemMeanBaseline
- 各アイテムの学習平均およびグローバル平均を算出し、未学習アイテムはグローバル平均にフォールバック。
- CF が本当に賢いのかを測る「最低限の比較対象」として設置。

### 3.2 User-based Collaborative Filtering
- 各ユーザ平均 `μ_u` を算出し、観測評価からこの平均を引く mean-centering を実施（楽観/悲観バイアスを除去）。
- 中心化行列でコサイン類似度を計算し、自己類似度は 0 に設定。
- 予測時はアイテムを評価済みの Top-k 近傍ユーザから、授業で扱った式
	\(\hat{r}_{ui} = μ_u + \frac{\sum_{v \in N_k} sim(u,v)(r_{vi}-μ_v)}{\sum_{v \in N_k} |sim(u,v)|}\)
	を用い、近傍不足時は `μ_u` へフォールバックした。

### 3.3 Item-based Collaborative Filtering
- ユーザ平均で中心化した行列を転置し、Adjusted Cosine 類似度でアイテム同士の近さを計算。
- ユーザ履歴内で類似度順に Top-k アイテムを抽出し、
	\(\hat{r}_{ui} = \frac{\sum_{j \in N_k} sim(i,j) r_{uj}}{\sum_{j \in N_k} |sim(i,j)|}\) を採用。
- 評価履歴が空のユーザはユーザ平均→グローバル平均の順にフォールバック。

## 4. 実験設定
- 近傍サイズ \(k \in \{5, 10, 20, 40\}\) を共通でスイープし RMSE / MAE を記録。
- HitRate@10 はベストモデルのみ計算し、テストアイテムが Top-10 に入る割合として算出。

## 5. 結果
### 5.1 Baseline vs CF（ベストハイパーパラメータのみ）

| Model             | k   | RMSE   | MAE    | HitRate@10 |
|-------------------|-----|--------|--------|------------|
| ItemMeanBaseline  | –   | 1.0981 | 0.8754 | 0.0011     |
| UserCF (k=40)     | 40  | 1.0478 | 0.8186 | 0.0000     |
| ItemCF (k=5)      | 5   | 3.0079 | 2.2376 | 0.0297     |

### 5.2 User-based CF における k スイープ

| k | RMSE   | MAE    |
|---|--------|--------|
| 5 | 1.1146 | 0.8756 |
|10 | 1.0663 | 0.8367 |
|20 | 1.0493 | 0.8217 |
|40 | **1.0478** | **0.8186** |

### 5.3 Item-based CF における k スイープ

| k | RMSE   | MAE    |
|---|--------|--------|
| 5 | 3.0079 | 2.2376 |
|10 | 3.0119 | 2.3442 |
|20 | 3.0825 | 2.5144 |
|40 | 3.1641 | 2.6693 |

## 6. 考察
- **Baseline vs User-based**: User-based CF (k=40) は RMSE で 0.0504、MAE で 0.0569 だけ改善し、mean-centering + Top-k 近傍により「似た嗜好を持つ友人の補助」が効果を示した。一方 HitRate@10 では差が出ず、leave-one-out のテスト 1 件を Top-10 に押し込むのが難しい課題設定であることを示している。
- **Item-based の悪化理由**: 今回の設定ではユーザよりアイテム数が多く、Adjusted Cosine に必要な十分な共評価が得られないアイテムが多数存在した。その結果、類似度行列が疎になり重み付き平均が安定せず RMSE/MAE とも大きく悪化した（HitRate@10 だけ高いのは一部の人気アイテムへのバイアスが働いたためと考えられる）。授業で紹介された「データ疎密と CF の相性」の通り、MovieLens 100K では user-user が優勢だった。
- **mean-centering / Top-k の意義**: mean-centering は個人バイアスを取り除き、類似度が嗜好の方向性を表すようにするため不可欠。Top-k 限定はノイズを抑え、説明可能な「近いユーザ／アイテム」だけを集約できる。
- **Hit/miss の捉え方**: HitRate@10 の値そのものは小さいものの、UserCF は個別の最新アイテムを Top-10 に載せられず、ItemCF は人気アイテムに偏ったヒットを出している。推薦の直感としては「人気偏重 vs 個人化」のトレードオフが浮き彫りになった。

## 7. 限界と発展案
- **コールドスタート**: 評価 1 件以下のユーザ／アイテムでは類似度が安定せず、Baseline 水準の精度しか得られない。
- **0 埋め行列によるバイアス**: 未観測を 0 と置いた密行列は計算が単純な一方で、明示的な欠損処理をしないとコサイン類似度が小さく出やすい。
- **計算コスト**: ユーザ × ユーザ、アイテム × アイテム のフル行列を構築するため \(O(n^2)\) メモリを消費し、MovieLens 100K 以上の規模では厳しい。
- **発展案**: Matrix Factorization (SVD++ / ALS) で潜在ベクトルを学習する、もしくは LLM などでメタデータを生成しハイブリッド化することで、コールドスタート緩和と精度向上が見込まれる。

## 8. レポート構成案（提出用）
1. 研究目的・課題の説明  
2. データセットの概要  
3. Baseline / User-based / Item-based のアルゴリズム説明  
4. 実装詳細（データ前処理、leave-one-out、行列構築、類似度計算）  
5. 実験設定（ハイパーパラメータ k、評価指標、HitRate 設定）  
6. 実験結果（RMSE/MAE 表、k スイープ表、HitRate）  
7. 考察（性能比較、mean-centering の効果、Top-k の役割、限界、将来展望）  
8. まとめ（学んだことと次の一手）

## 9. まとめ
- leave-one-out による未来予測を想定した評価セットで、User-based CF が Baseline を上回り、本授業で学んだ mean-centering と Top-k 近傍の有効性を確認した。
- Item-based CF は本データの疎密条件では不利であり、アイテム共評価を増やす前処理や、潜在因子モデル・ハイブリッド型への拡張が次の課題となる。
